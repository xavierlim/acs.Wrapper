!PreReleasePanelBuffer

global int PreReleaseStateError
PreReleaseStateError = 0

int ReleaseCommandReceived
int WaitTimeToExit


if CURRENT_STATUS = LOADED_STATUS
	CURRENT_STATUS = PRERELEASING_STATUS
	PanelFreed = 0
	START FreePanelBufferIndex,1
	TILL ^ PST(FreePanelBufferIndex).#RUN

	if PanelFreed = 0
		PreReleaseStateError = 2
		CALL ErrorExit
		CURRENT_STATUS = ERROR_STATUS
	else
	    ReleaseCommandReceived = -1
		CALL StartConveyorBeltsDownstream
		TILL ReleaseCommandReceived <> -1,WaitTimeToExit
		if ReleaseCommandReceived <> 1
			if IN(ExitOpto_Port).ExitOpto_Bit = 1
				CALL TurnOffConveyor
				CURRENT_STATUS = PRERELEASED_STATUS
			else
				PreReleaseStateError = 3
				CALL ErrorExit
				CURRENT_STATUS = ERROR_STATUS
			end
		end
	end

else
	PreReleaseStateError = 1
	CALL ErrorExit
	CURRENT_STATUS = ERROR_STATUS
end

STOP

StartConveyorBeltsDownstream:
	JOG/v CONVEYOR_AXIS,ConveyorBeltReleaseSpeed
RET

TurnOffConveyor:
	HALT CONVEYOR_AXIS
RET

ErrorExit:
	START InternalErrorExitBufferIndex,1
	TILL ^ PST(InternalErrorExitBufferIndex).#RUN
RET
