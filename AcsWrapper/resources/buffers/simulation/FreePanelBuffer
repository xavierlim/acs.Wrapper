!FreePanelBuffer

global int FreePanelStateError
FreePanelStateError = 0

global int FreePanelStopUpError,FreePanelOptoBlockedError,FreePanelToUnliftError,FreePanelToUnclampError

FreePanelStopUpError=1
FreePanelOptoBlockedError=2
FreePanelToUnliftError=3
FreePanelToUnclampError=4

int UnclampLiftDelayTime
int WaitTimeToUnlift
int WaitTimeToUnclamp

PanelFreed = -1

if StopperArmDown_Bit = 1
	CALL TurnOnPanelSensingOptos
	if (EntryOpto_Bit = 0 & ExitOpto_Bit = 0)
		CALL UnclampPanel
		WAIT UnclampLiftDelayTime
		CALL LowerLifter
		TILL Lifter_Lowered = 1,WaitTimeToUnlift
		if Lifter_Lowered <> 1
			FreePanelStateError = FreePanelToUnliftError
		else
			TILL RearClampDown_Bit & FrontClampDown_Bit,WaitTimeToUnclamp
			if(RearClampDown_Bit & FrontClampDown_Bit)
				PanelFreed = 1
			else
				FreePanelStateError = FreePanelToUnclampError
			end
		end
	else
		FreePanelStateError = FreePanelOptoBlockedError
	end
else
	FreePanelStateError = FreePanelStopUpError
end

STOP


TurnOnPanelSensingOptos:
	StopSensor_Bit = 1
RET

LowerLifter:
	Lifter_Lowered = 0
	ptp/v LIFTER_AXIS,0,10
	till ^MST(LIFTER_AXIS).#MOVE
	wait 200
	Lifter_Lowered = 1
RET


UnclampPanel:
	ClampPanel_Bit = 0
RET
